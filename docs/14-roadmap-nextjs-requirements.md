# 機能要件に近づけるロードマップ（Next.js + UI のまま）

UI は維持し、Next.js のまま機能要件のみを追加・拡張する方針。実装の優先度と依存関係を整理する。

---

## ブランチのナンバリングと命名

[08-implementation-order.md](08-implementation-order.md) のフェーズ 0〜8 に続き、本ロードマップ用に **9 から** 番号を振る。命名形式は `feature/{番号}-{ケバブケース}` で統一する。

| 番号 | ブランチ名 | 対応フェーズ | 内容 |
|------|------------|--------------|------|
| 9 | `feature/9-decision-maker-csv-export` | A | 代表者名の抽出・表示・出力 ＋ CSV エクスポート |
| 10 | `feature/10-ir-pdf` | B | IR 情報 PDF の取得・テキスト抽出・要約への組み込み |
| 11 | `feature/11-company-list-search` | C | 検索による企業リスト作成・候補一覧 UI・一括 CSV 出力 |
| 12 | `feature/12-google-sheet-docs-export` | D | Google スプレッドシート／ドキュメントへの出力 |
| 13 | `feature/13-video-google-info` | E | 動画 URL 抽出・Google 上の企業情報 |

**運用**: 実装時は `develop`（または main）から上記ブランチを切り、完了後にマージする。番号順（9 → 10 → …）で進めると依存関係が崩れにくい。

---

## 方針

- **維持**: Next.js、Web UI、現行の「1企業ずつ URL 入力 → HP クロール → 要約・仮説・手紙」フロー。
- **追加**: 要件で不足している機能を段階的に実装する（リスト取得、PDF、代表者名、Sheet/Docs/CSV 出力など）。
- **規約・仕様**: 従来どおり robots.txt 尊重・断定を避けた表現・自動送信なし。

---

## 追加機能がもたらす効果（論理的な整理）

各フェーズの追加が、**なぜ**効果を持つかを「目的 → できること → 得られる結果」の流れで整理する。

### 前提：アプリの目的

HypoFrame の目的は、**企業情報に基づく「課題仮説 → 提案」の下書きを生成し、営業・提案活動の準備を効率化すること**である。したがって、

- **入力**が豊かになるほど仮説の根拠が厚くなり、
- **出力**が業務フローに載りやすいほど、生成結果が実際のアクションに結びつきやすくなる。

以下は、その両面から各追加機能の効果を論理づけたものである。

---

### フェーズ A の効果：宛先の具体化と表形式での再利用

| 機能 | 論理の流れ | もたらす効果 |
|------|------------|--------------|
| **代表者名（A1）** | 手紙は「誰宛てか」が明示されていないと、送付・フォローが曖昧になる。HP や IR に記載された代表者・役員名を抽出し、下書きに紐づけることで、**宛先が特定可能**になる。 | 手紙下書きが「誰に届けるか」まで一貫した形で扱え、名刺・DM の宛名や社内共有時の説明がしやすくなる。結果として**下書きの実用性（そのまま使える度合い）が上がる**。 |
| **CSV エクスポート（A2）** | 要約・仮説・手紙は「1行1企業」の表形式にすると、並べ替え・フィルタ・他システムとの突き合わせができる。テキストだけでは表計算や CRM に載せづらい。 | 生成結果を**表として扱える**ようになり、優先度付け・進捗管理・他ツール（Excel 等）との連携がしやすくなる。複数企業を扱うフェーズ C 以降では、**一覧性と分析可能性**の土台になる。 |

**まとめ**: A は「1企業あたりのアウトプットの完成度」と「結果を業務でどう使うか」を高める。代表者名で宛先を明確にし、CSV で表として扱えるようにすることで、**生成したものの実用性と再利用性**が上がる。

---

### フェーズ B の効果：仮説の根拠の厚みと説得力

| 論理の流れ | もたらす効果 |
|------------|--------------|
| 企業の**経営方針・業績・リスク**は、HP のテキストより **IR 資料（PDF）** に多く記載されている。HP だけを入力にすると、数値や中期計画に基づく仮説が立てにくい。IR のテキストを取得・要約し、要約・仮説の入力に含めることで、**入力情報の質と量が増える**。 | 仮説が「HP の印象」だけでなく**IR に書かれた事実（売上構成・リスク要因・方針）** に紐づくようになる。その結果、**仮説の根拠が説明しやすくなり、提案の説得力**が上がる。また「IR 要約」を明示すれば、営業側が「何を根拠にしているか」を社内で共有しやすくなる。 |

**まとめ**: B は**入力側の拡張**である。IR PDF を取り込むことで、生成される仮説・提案が「HP のみ」の場合より根拠が厚くなり、**炎上・誤認防止**（断定を避ける方針）と両立したまま、**提案の信頼性**を高められる。

---

### フェーズ C の効果：対象企業の拡大とリスト運用の効率化

| 論理の流れ | もたらす効果 |
|------------|--------------|
| 現状は「知っている企業の URL を 1 件ずつ入力」に依存している。**検索条件（業界・地域・キーワード）で候補を取得**し、一覧から選択して仮説生成できるようにすると、**候補発見の工数**が減る。 | **扱える企業数が増えやすくなる**。営業範囲を「すでに URL を知っている企業」から「条件で抽出した企業」に広げられる。リスト作成と仮説生成が同一フローで完結するため、**リスト運用と提案準備を一気通貫**で行える。 |
| 複数企業の結果を **CSV 一括出力**できると、候補リストと生成結果を 1 つの表で管理できる。 | **優先度付け**（どの企業からアプローチするか）や**進捗の可視化**がしやすくなり、営業活動の**計画と振り返り**に使える。 |

**まとめ**: C は**入力の入口を広げる**機能である。検索ベースのリスト作成と一括出力により、「候補の発見 → 仮説生成 → 結果の整理」がつながり、**スケール（対象企業数の増加）と運用効率**が両立する。

---

### フェーズ D の効果：既存業務フローへの組み込みと共有のしやすさ

| 論理の流れ | もたらす効果 |
|------------|--------------|
| 多くの組織では、**商談先リスト・進捗・提案メモを Google スプレッドシートで管理**している。アプリ内で完結した結果を、**そのままスプレッドシートに書き込める**と、**既存の「見る場所・更新する場所」に載せられる**。 | **ツールの切り替えが減り、HypoFrame の結果を「いつもの Sheet」で確認・編集・共有できる**。その結果、**導入障壁が下がり、継続利用**しやすくなる。 |
| 手紙下書きを **Google ドキュメント** に出力すると、**体裁の調整・上司のレビュー・メールへの貼り付け**を Docs 上で完結できる。 | 下書きの**編集と共有**が、すでに使い慣れた環境で行えるため、**「生成 → 手を入れて送る」までの一連の作業**がスムーズになる。 |

**まとめ**: D は**出力先を既存の業務環境に合わせる**機能である。CSV（A2）で「表として扱う」ことはできるが、**日常的に Sheet / Docs を使っている組織では、そこに直接書き込める方が受け入れられやすい**。その結果、**採用率と定着率**の向上が期待できる。

---

### フェーズ E の効果：情報の網羅性（補助）

| 論理の流れ | もたらす効果 |
|------------|--------------|
| **動画 URL** を抽出しておくと、後から「説明動画やIR説明会のリンク」を参照できる。**Google 上の企業情報**（概要・ニュース）を補助入力にすると、HP に載っていない直近の動きを要約に反映できる。 | 入力の**網羅性**が上がり、仮説や提案が「HP のスナップショット」だけでなく、**動画や外部情報を踏まえた内容**に近づく。必須ではないが、**精度・納得感の向上**に寄与する。 |

**まとめ**: E は情報源の拡張である。動画 URL と Google 上の企業情報を追加し、仮説の質を底上げする。

---

### 効果の依存関係（まとめ図）

```
A（代表者名・CSV）
  → 1件あたりの完成度↑、表としての再利用可能
  → 下書きの実用性・一覧性の土台

B（IR PDF）
  → 入力の質・量↑
  → 仮説の根拠と説得力↑

C（リスト作成）
  → 候補発見の効率化、複数企業の一括処理
  → 対象企業数の拡大、リスト運用の一気通貫

D（Sheet / Docs）
  → 出力先が既存業務フローに載る
  → 導入障壁↓、継続利用↑

E（動画・Google情報）
  → 情報の網羅性↑（補助）
  → 仮説の精度・納得感の向上
```

したがって、**A で「1件の質と表形式」を固め、B で「入力の厚み」を足し、C で「規模と運用」を広げ、D で「業務への載せ方」を整える**という順序は、それぞれの効果が次のフェーズの前提になるという意味で、論理的にも妥当である。

---

## 機能の優先度とフェーズ

| フェーズ | 機能 | 要件との対応 | 難易度・依存 |
|----------|------|--------------|----------------|
| **A** | 代表者名の抽出・表示・出力 | ③代表者名、④出力項目 | 低（LLM または正規表現） |
| **A** | CSV エクスポート | ④スプレッドシート/CSV の代替 | 低（既存 .txt の横に CSV 追加） |
| **B** | IR 情報 PDF の取得・要約 | ②IR PDF、③IR 要約 | 中（PDF 取得・テキスト抽出） |
| **C** | リスト作成（検索→企業リスト） | ①リスト作成 | 中（Google API または代替） |
| **D** | Google スプレッドシート出力 | ④必須出力 | 中（Google API 設定） |
| **D** | Google ドキュメント出力（手紙） | ④手紙の Docs 出力 | 中（Google API） |
| **E** | 動画 URL 抽出 | ②動画 | 低〜中（リンク抽出） |
| **E** | Google 上の企業情報 | ②周辺情報 | 中（検索 API 等） |

---

## フェーズ A: すぐ効く拡張（代表者名・CSV）

### A1. 代表者名（代表者/役員等）

- **やること**
  - クロール済みテキスト（または要約前の構造化テキスト）から「代表者」「役員」「取締役」等を LLM または正規表現で抽出。
  - 型・DB: `Run` に `decisionMakerName: string | null`（または `representativeName`）を追加。API の Request/Response にも追加。
  - UI: 結果エリアに「代表者名（分かれば）」を表示。エクスポート・コピーに含める。
- **実装イメージ**
  - `lib/groq.ts` に「代表者名抽出」用の短いプロンプトを 1 回追加するか、要約プロンプトの JSON に `decisionMakerName` を追加。
  - または `lib/prompts.ts` で要約出力を `{ industry, employeeScale, summaryBusiness, decisionMakerName }` に拡張。
- **依存**: なし。既存クロールのまま使える。

### A2. CSV エクスポート

- **やること**
  - 1 件の結果を「企業名, URL, 要約, 仮説1〜5, 代表者名, 手紙下書き」の 1 行（または複数行に分割）で CSV 出力。
  - 既存の .txt エクスポートの横に「CSV でダウンロード」ボタンを追加。BOM 付き UTF-8 で Excel でも開きやすくする。
- **実装イメージ**
  - `lib/export.ts` に `buildExportCsv(...)` を追加。`ResultArea` から CSV ダウンロードを呼ぶ。
- **将来**: フェーズ C で「リスト＋複数企業の結果」を一括 CSV 出力するときに同じフォーマットを流用できる。

---

## フェーズ B: IR 情報 PDF

- **やること**
  - Page Collector または Structurizer の後段で、同一ドメインの「.pdf」リンクを最大 N 本まで取得。
  - PDF をバイナリ取得 → テキスト抽出（例: `pdf-parse` 等の Node 用ライブラリ）。
  - 抽出テキストを構造化テキストと結合し、要約・仮説の入力に含める。必要なら「IR 要約」を別フィールドで返す（要件③）。
- **注意**
  - PDF のサイズ・ページ数制限、タイムアウト、取得失敗時は HP のみで継続するフォールバックを入れる。
  - robots.txt で PDF が Disallow の場合は取得しない。
- **依存**: 新規 npm パッケージ（PDF パーサー）。既存の 90 秒タイムアウト内に収める必要あり。

---

## フェーズ C: リスト作成（検索 → 企業リスト）

- **やること**
  - **入力**: 検索クエリ（キーワード、および業界・地域などの条件）を UI で入力。
  - **取得**: Google Custom Search API（または SerpAPI 等）で検索結果を取得。1 件あたり「タイトル・URL・スニペット」をパース。
  - **UI**: 取得結果を「企業候補リスト」として一覧表示。ユーザーがチェックまたは選択して「仮説生成を実行」できるようにする。既存の「1 URL 入力」はそのまま残す。
  - **出力**: リスト＋各企業の結果を「CSV 一括ダウンロード」できるようにする（フェーズ A2 の CSV フォーマットを複数行に拡張）。
- **規約**
  - Google Custom Search API は利用規約・クォータに従う。スクレイピングではなく API 利用を明示。
- **依存**: Google API キー・Custom Search Engine ID（.env で管理）。リスト用の state/画面を追加。

---

## フェーズ D: Google スプレッドシート / ドキュメント出力

- **やること**
  - **スプレッドシート**: 企業名 / URL / 要約 / 仮説（5段を 1 セル or 5 列）/ 代表者名 / 手紙下書き を 1 行（または見やすい形）で書き込み。新規シート作成 or 既存シートに追記のどちらかを選べるようにする。
  - **ドキュメント**: 手紙下書きだけを Google ドキュメントに新規作成するオプション。
  - **認証**: Google OAuth 2.0（ユーザーごとに「スプレッドシート・ドキュメントへのアクセス」を許可）。または Service Account で「アプリ用の 1 フォルダ」に書き込む方式。
- **UI**
  - 結果画面に「Google スプレッドシートに出力」「Google ドキュメントに出力（手紙）」ボタンを追加。初回は Google ログイン（スコープ追加）を促す。
- **依存**: Google Cloud プロジェクト、Sheets API / Docs API、OAuth または Service Account の設定。既存 Supabase 認証と Google 連携をどう扱うか（同一アカウント or 別連携）の設計が必要。

---

## フェーズ E: 動画 URL・Google 企業情報

- **動画 URL 抽出**: クロールした HTML から `iframe` / `video` / 特定ドメイン（YouTube 等）のリンクを抽出し、結果に「動画 URL」として表示・CSV/Sheet に含める。音声の文字起こしは行わない。
- **Google 上の企業情報**: 企業名で検索し、スニペットやニュース見出しを 1〜2 件取得して要約の補助入力にする。Custom Search API の結果を利用する。規約・クォータに従う。

---

## 実装順序

1. **A1 → A2**: 代表者名を追加してから、CSV に代表者名を含め、CSV エクスポートを用意する。
2. **B**: A の次に実装する。「要約・仮説・手紙・代表者名・IR（PDF）」が揃う。
3. **C**: リスト作成。A2 の CSV が一括出力で使える。
4. **D**: C の次に実装する。CSV に加えて Sheet/Docs を出力先として選べるようにする。
5. **E**: 9〜12 の後に実装する。動画 URL と Google 企業情報を追加する。

---

## 技術的な実装要件定義

追加機能に伴う**DB カラム・テーブル**、**npm 依存**、**環境変数**、**API 契約の変更**、**フェーズ間依存**を定義する。実装時はこの一覧と各フェーズの「実装するもの（詳細）」を合わせて参照する。

### フェーズ別 技術要件一覧

| フェーズ | 追加カラム／テーブル | npm 依存 | 環境変数 | 新規／変更 API | 先行フェーズ |
|----------|------------------------|----------|----------|----------------|--------------|
| **A** | `runs.decision_maker_name` (text, nullable) | なし | なし | `POST /api/generate` レスポンスに `decisionMakerName` 追加。`POST /api/runs`・`PATCH /api/runs/[id]` の Body に `decisionMakerName` 追加。 | なし |
| **B** | `runs.ir_summary` (text, nullable)（IR 要約を別フィールドで返す場合） | PDF テキスト抽出（例: `pdf-parse`） | なし | `POST /api/generate` レスポンスに `irSummary` 追加。`POST /api/runs`・`PATCH /api/runs/[id]` の Body に `irSummary` 追加。 | A（CSV に代表者名が含まれる前提） |
| **C** | なし（runs は既存のまま。一覧はクライアント state または既存 runs 取得で賄う） | なし | `GOOGLE_CSE_API_KEY`（または `GOOGLE_API_KEY`）、`GOOGLE_CSE_CX` | 新規: `GET /api/search?q={query}` または `POST /api/search` Body `{ query: string }`。レスポンス: `{ items: { title, link, snippet }[] }`。 | A（A2 の CSV フォーマットで一括出力するため） |
| **D** | なし。OAuth トークン保持用に `user_google_tokens` 等のテーブルを用意する場合は別設計。 | Google APIs クライアント（例: `googleapis`） | `GOOGLE_CLIENT_ID`、`GOOGLE_CLIENT_SECRET`、コールバック URL 用の `NEXT_PUBLIC_APP_URL` 等 | 新規: `GET /api/auth/google`（OAuth 開始）、`GET /api/auth/google/callback`（コールバック）。新規: `POST /api/export/google-sheet`、`POST /api/export/google-docs`（要設計）。 | A（代表者名・CSV 項目が Sheet に含まれるため） |
| **E** | なし（`videoUrls` は API レスポンス・画面表示用。runs に持つ場合は `runs.video_urls text[]` または JSON で追加） | なし | C で導入済みの `GOOGLE_CSE_*` を流用可能 | `POST /api/generate` レスポンスに `videoUrls?: string[]` 追加。Google 企業情報は既存 Custom Search を generate 前の 1 回呼びで利用。 | C（検索 API 利用）、A（CSV 列に動画 URL を追加） |

### 追加カラムの定義（DDL）

**フェーズ A**

```sql
-- supabase/migrations/YYYYMMDD_add_decision_maker_name.sql
ALTER TABLE runs ADD COLUMN IF NOT EXISTS decision_maker_name text;
```

**フェーズ B（IR 要約を別フィールドで持つ場合）**

```sql
-- supabase/migrations/YYYYMMDD_add_ir_summary.sql
ALTER TABLE runs ADD COLUMN IF NOT EXISTS ir_summary text;
```

**フェーズ E（動画 URL を runs に保存する場合）**

```sql
-- 省略可。API レスポンスと UI のみで扱う場合はカラム追加なし。
-- 保存する場合の例:
ALTER TABLE runs ADD COLUMN IF NOT EXISTS video_urls text[];  -- または jsonb
```

### 環境変数一覧（フェーズ C 以降）

| 変数名 | フェーズ | 説明 |
|--------|----------|------|
| `GOOGLE_CSE_API_KEY` または `GOOGLE_API_KEY` | C, E | Google Custom Search API キー |
| `GOOGLE_CSE_CX` | C, E | Custom Search エンジン ID |
| `GOOGLE_CLIENT_ID` | D | Google OAuth 2.0 クライアント ID |
| `GOOGLE_CLIENT_SECRET` | D | Google OAuth 2.0 クライアントシークレット（サーバー側のみ） |
| `NEXT_PUBLIC_APP_URL` 等 | D | OAuth コールバックのベース URL |

### 型・API 契約の変更一覧

| 対象 | フェーズ | 変更内容 |
|------|----------|----------|
| `types/generate.ts` `GenerateResponse` | A | `decisionMakerName?: string \| null` 追加 |
| `types/run.ts` `Run`, `RunInsert` | A | `decisionMakerName: string \| null` 追加 |
| `lib/export.ts` | A | `buildExportCsv(...)`, `buildExportText` に `decisionMakerName` を渡す。CSV 用ファイル名関数。 |
| `types/generate.ts` `GenerateResponse` | B | `irSummary?: string \| null` 追加（別フィールドで返す場合） |
| `types/run.ts` `Run`, `RunInsert` | B | `irSummary: string \| null` 追加（同上） |
| 新規 `types/search.ts` 等 | C | 検索 API レスポンス型 `{ items: { title, link, snippet }[] }` |
| `types/generate.ts` `GenerateResponse` | E | `videoUrls?: string[]` 追加 |
| `types/run.ts`（runs に保存する場合） | E | `videoUrls: string[] \| null` 追加 |

### フェーズ間依存（実装順の根拠）

```
A（代表者名・CSV）
  ↑ 依存なし

B（IR PDF）
  → A 完了後。runs に decision_maker_name が入っている前提で PATCH 等が動く。

C（リスト作成）
  → A 完了後。一括 CSV の列が A2 で定義されたフォーマット（代表者名含む）と一致する。

D（Sheet / Docs）
  → A 完了後。出力項目に代表者名が含まれる。B の ir_summary を含める場合は B 完了後。

E（動画・Google 企業情報）
  → C 完了後（検索 API 利用）。A 完了後（CSV に動画 URL 列を追加）。B は必須ではない。
```

### マイグレーション・リリース時の注意

- 各フェーズで追加するカラムは `ADD COLUMN IF NOT EXISTS` とし、既存環境で重複実行してもエラーにしない。
- 環境変数は `.env.example` に変数名と説明のみ記載し、値は含めない。フェーズ C 以降で必要な変数を追記する。
- API のレスポンスにフィールドを**追加**するだけなら既存クライアントは壊れない。**削除・必須化**は行わない。

---

## チェックリスト（要件との対応）

実装後に照合する用。

| 要件 | 対応するフェーズ |
|------|------------------|
| ① 条件で検索 → 企業名・URL 抽出 | C（リスト作成） |
| ① 出力: スプレッドシート or CSV | A2（CSV）、D（Sheet） |
| ② 企業公式 HP | 既存 |
| ② HP 内 IR PDF | B |
| ② Google 企業情報・動画 URL | E |
| ③ 事業要約・IR 要約・代表者名・手紙下書き | 既存 + A1 + B |
| ④ スプレッドシート: 企業名/URL/要約/仮説/決裁者/手紙 | A1+A2+D |
| ④ 手紙の Google ドキュメント出力 | D |
| UI は持たせる・Next.js のまま | 全フェーズで維持 |

この順で進めれば、機能要件に近づけつつ、Next.js と UI を維持したまま段階的にリリースできる。

---

## 実装の詳細度の確認

[08-implementation-order.md](08-implementation-order.md) と同水準で「実装するもの」「確認」を揃えるため、以下で**詳細に定義されているか**を整理した。不足している場合は各フェーズ末尾の「未決定・実装前に決めること」で補う。

| フェーズ | 詳細に定義されているもの | 不足・曖昧なもの |
|----------|--------------------------|------------------|
| **A** | 対象ファイル（lib/groq, prompts, export, ResultArea）、型・DB の追加項目、UI の場所、CSV の BOM UTF-8 | 代表者名の抽出方式（LLM  vs 正規表現）の選定、確認チェックリスト、マイグレーションの有無（既存 DB に decision_maker 追加） |
| **B** | 処理の流れ（PDF リンク取得→取得→テキスト抽出→要約入力に結合）、robots 尊重、フォールバック方針 | 「最大 N 本」の N、使用する PDF ライブラリ名、IR 要約を別フィールドで返すか、runs テーブルに ir_summary を追加するか、確認チェックリスト |
| **C** | 入力（検索クエリ）、取得元（Custom Search API 等）、UI の役割（候補一覧・選択・仮説生成）、出力（一括 CSV） | 検索 API のエンドポイント（例: GET /api/search?q=）、リクエスト/レスポンス型、業界・地域の渡し方、一括 CSV のデータソース（選択済み候補を逐次生成するか／既存 runs のみか）、確認チェックリスト |
| **D** | 出力先（Sheet/Docs）、書き込む項目、認証の選択肢（OAuth / Service Account）、UI のボタン配置 | 認証方式の決定、スコープ一覧、新規/既存シートの選び方 UI、確認チェックリスト |
| **E** | 動画 URL の抽出元（iframe/video/YouTube）、Google 企業情報の利用方法（1〜2 件） | 取得件数・文字数上限、要約への組み込みルール、確認チェックリスト（フェーズ9〜12の後に実装） |

以下、各フェーズに**実装するもの（詳細）**・**確認**・**未決定・実装前に決めること**を追記する。

---

## フェーズ A 実装詳細（代表者名・CSV）

### 実装するもの（詳細）

- **A1 代表者名**
  - **DB**: `runs` に `decision_maker_name text` を追加。マイグレーション `supabase/migrations/YYYYMMDD_add_decision_maker_name.sql` で `ALTER TABLE runs ADD COLUMN decision_maker_name text;`。
  - **型**: `types/run.ts` の `Run` に `decisionMakerName: string | null`。`GenerateResponse`（`types/generate.ts`）に `decisionMakerName?: string | null`。
  - **プロンプト**: `lib/prompts.ts` の要約用 JSON を `{ industry, employeeScale, summaryBusiness, decisionMakerName }` に拡張。`decisionMakerName` は「代表者・役員・取締役等、分かれば1名」と指示。
  - **API**: `POST /api/generate` の成功時レスポンスに `decisionMakerName` を含める。`POST /api/runs`・`PATCH /api/runs/[id]` の Body に `decisionMakerName` を追加。
  - **UI**: `ResultArea` に「代表者名（分かれば）」を表示。`lib/export.ts` の `buildExportText` とコピー用テキストに含める。
- **A2 CSV エクスポート**
  - **lib/export.ts**: `buildExportCsv(summaryBusiness, hypothesisSegments, letterDraft, companyName?, industry?, employeeScale?, decisionMakerName?)` を追加。1 行 1 企業。項目は「企業名, URL, 業種, 従業員規模, 代表者名, 要約, 仮説1, 仮説2, 仮説3, 仮説4, 仮説5, 手紙下書き」。フィールド内にカンマ・改行を含む場合はダブルクォートで囲む。BOM 付き UTF-8。
  - **ResultArea**: 「CSV でダウンロード」ボタンを追加。ファイル名は `仮説_会社名_YYYYMMDD.csv` とし、`getExportFileName` を拡張するか別関数とする。

### 確認

- [ ] 要約生成時に `decisionMakerName` が JSON に含まれ、画面・エクスポート・コピーに表示される
- [ ] 代表者名が取得できない場合は null または空で表示され、エラーにならない
- [ ] CSV ダウンロードで BOM 付き UTF-8 の 1 行が取得でき、Excel で文字化けしない
- [ ] CSV に企業名・URL・要約・仮説1〜5・代表者名・手紙下書きが含まれる
- [ ] 既存の .txt エクスポート・コピーに代表者名が含まれる

### 未決定・実装前に決めること

- 代表者名の抽出を**要約プロンプトの JSON に含める**か、**別の LLM 呼び出し**か。要約 1 回の JSON に含めると呼び出し回数が増えず、レスポンスも揃う。

---

## フェーズ B 実装詳細（IR PDF）

### 実装するもの（詳細）

- **PDF 取得**: クロール済み HTML から同一ドメインの `href` で `.pdf` で終わるリンクを最大 **2 本**まで取得（N=2。要約・仮説の入力長と 90 秒制限のバランス）。
- **ライブラリ**: Node 用 PDF テキスト抽出（例: `pdf-parse`）。`package.json` に追加。
- **処理**: `lib/crawl.ts` の後段、または `app/api/generate/route.ts` 内で「クロール結果の HTML から PDF URL を列挙 → robots で許可されていれば fetch → テキスト抽出 → 構造化テキストと結合」。PDF が取得できない・タイムアウト・空の場合は HP テキストのみで継続。
- **出力**: IR 要約を**別フィールド**で返すか、要約に含めるだけにするか。要件③「IR 要約」を満たすなら `GenerateResponse` に `irSummary?: string | null` を追加し、`runs` に `ir_summary text` を追加する案が明確。UI で「IR 要約」を表示する場合は DB と型の追加が必要。
- **制限**: PDF 1 本あたりページ数上限（例: 20 ページ）またはバイト上限を設け、超過分は切り捨て。

### 確認

- [ ] 企業 HP に .pdf リンクがある場合、同一ドメインの PDF を最大 2 本まで取得し、テキストが要約・仮説の入力に含まれる
- [ ] PDF が Disallow または 403 の場合はスキップし、HP のみで生成が完了する
- [ ] 90 秒タイムアウト内に収まる（PDF 取得が長引く場合は打ち切り）
- [ ] IR 要約を別表示する場合、画面とエクスポートに「IR 要約」が含まれる

### 未決定・実装前に決めること

- **N（PDF 本数）**: 2 本とする。
- **IR 要約を別フィールドで返すか**: 要件③「IR 要約」を満たすため、`irSummary` を LLM で生成し、`GenerateResponse` と `runs.ir_summary` に持つかどうか実装前に決定する。
- **使用する PDF ライブラリ**: `pdf-parse` 等、Node で動くものを 1 つ選ぶ。

---

## フェーズ C 実装詳細（リスト作成）

### 実装するもの（詳細）

- **API**: `GET /api/search?q={検索クエリ}` または POST で Body `{ query: string }`。Google Custom Search API を呼び、レスポンスを `{ items: { title, link, snippet }[] }` の形で返す。業界・地域はクエリ文字列に含める（例: `q=業界名 地域名 キーワード`）。
- **環境変数**: `.env.local` に `GOOGLE_CSE_API_KEY`（または `GOOGLE_API_KEY`）、`GOOGLE_CSE_CX`（検索エンジン ID）を追加。`.env.example` に記載。
- **UI**: ホームに「検索で企業候補を取得」入力欄とボタンを追加。検索結果を一覧表示し、チェックボックスで選択。「選択した候補で仮説生成」で、選択 URL を 1 件ずつ（または並列で）既存 `POST /api/generate` に送り、結果を蓄積。既存の「1 URL 入力」は残す。
- **一括 CSV**: 蓄積した結果（企業名・URL・要約・仮説・代表者名・手紙）を A2 の CSV フォーマットで複数行出力。ダウンロードは「結果一覧を CSV でダウンロード」ボタンで実行。

### 確認

- [ ] 検索クエリを入力して実行すると、候補一覧（タイトル・URL・スニペット）が表示される
- [ ] 候補を選択して「仮説生成」を実行すると、各 URL で生成が走り、結果が一覧に追加される
- [ ] 一括 CSV ダウンロードで、複数企業分の行が含まれる
- [ ] Google API の利用規約・クォータに従い、API キーはサーバー側のみで使用する

### 未決定・実装前に決めること

- **並列生成の有無**: 複数選択時に 1 件ずつ順次実行するか、並列（同時 2〜3 件等）にするか。順次なら実装が簡単でタイムアウトも扱いやすい。
- **業界・地域の入力方法**: クエリ 1 つにまとめるか、フォームで「業界」「地域」「キーワード」を分けるか。MVP はクエリ 1 つとする。

---

## フェーズ D 実装詳細（Google Sheet / Docs）

### 実装するもの（詳細）

- **認証**: **OAuth 2.0** とする（ユーザーごとに自分の Sheet/Docs に書き込む）。スコープは `https://www.googleapis.com/auth/spreadsheets`、`https://www.googleapis.com/auth/documents`。既存 Supabase 認証と Google アカウントは別連携（Google ログインボタンで OAuth し、トークンをセッション or DB に保持）とする。
- **Sheet**: 書き込み項目は「企業名, URL, 要約, 仮説1〜5, 代表者名, 手紙下書き」を 1 行に。新規シート作成時はスプレッドシートを新規作成し、1 シート目に上記ヘッダーと 1 行目を書き込む。既存シートに追記する場合は、スプレッドシート ID とシート名をユーザーが入力するか、前回書き込んだ ID を記憶する。
- **Docs**: 手紙下書きのテキストで新規ドキュメントを作成。タイトルは「提案文下書き_会社名_YYYYMMDD」など。
- **UI**: ResultArea に「Google スプレッドシートに出力」「Google ドキュメントに出力（手紙）」ボタン。未連携時は「Google と連携」を促し、OAuth フローへ。

### 確認

- [ ] Google 連携後、1 件の結果を「スプレッドシートに出力」で新規シートに書き込める
- [ ] 「ドキュメントに出力」で手紙下書きのみの新規ドキュメントが作成される
- [ ] 未連携時はボタンで OAuth が開始され、連携後は書き込みが成功する
- [ ] API キー・クライアント ID はサーバー側または環境変数で管理し、クライアントに露出しない

### 未決定・実装前に決めること

- **OAuth と Service Account のどちらにするか**: ユーザーごとに「自分の Sheet」に書きたいなら OAuth。共通の 1 フォルダに集約するなら Service Account も可。
- **既存シートへの追記 UI**: スプレッドシート ID を入力させるか、直近で作成したシートに追記するか。MVP は新規作成のみとする。

---

## フェーズ E 実装詳細（動画 URL・Google 企業情報）

### 実装するもの（詳細）

- **動画 URL**: クロール済み HTML から `iframe[src]`、`a[href]` で YouTube / vimeo 等のドメインを抽出。最大 5 件まで。`GenerateResponse` に `videoUrls?: string[]` を追加。UI と CSV に「動画 URL」列を追加。
- **Google 企業情報**: 企業名で Custom Search API を 1 回呼び、スニペットを 1〜2 件取得。要約プロンプトの入力テキストの**先頭または末尾**に「補足: （スニペット）」を付与。別フィールドで返すかは実装時に決める。

### 確認

- [ ] HP に YouTube 等のリンクがある場合、結果に「動画 URL」が表示され、CSV に含まれる
- [ ] Google 企業情報を有効にした場合、要約にその内容が反映される

### 未決定・実装前に決めること

- フェーズ E は 9〜12 完了後に実装する。動画 URL と Google 企業情報の実装順は実装時に決める。
