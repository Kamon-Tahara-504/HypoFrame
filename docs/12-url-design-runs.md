# 履歴（run）と URL 設計

## 現状の設計

- **ルート**: ホームは `/` のみ。新規チャットへのリセットは `/?new=1` で表現。
- **履歴の選択**: サイドバーで run をクリックすると `handleSelectRun(id)` が呼ばれ、`GET /api/runs/[id]` で取得した内容を **React の state だけ** に格納する。
- **URL は変わらない**: どの run を表示していてもブラウザのパスは常に `http://localhost:3000/`（または `/?new=1`）のまま。
- **状態の持ち方**: `selectedRunId`, `result`, `hypothesisSegments`, `letterDraft`, `runId` などはすべてクライアントの state。サーバー側や URL には一切出てこない。

### 現状で起きること

| 操作 | 結果 |
|------|------|
| 履歴で「株式会社ドワンゴ」を選択 | 画面だけ切り替わり、URL は `/` のまま |
| その URL をコピーして別タブで開く | 入力画面（または初期状態）になる。ドワンゴの結果は出ない |
| 表示中にブラウザをリロード | 状態が消え、入力画面に戻る |
| ブラウザの「戻る」 | 履歴 A → B と見て戻っても、アプリ内の「前の run」には戻らない（通常は別サイトへ） |

---

## パスを変える設計（例: `/r/[runId]`）

- **ルート例**: `/` = 新規チャット、`/r/[runId]` = 指定 run の表示・編集。
- 履歴クリック時: `router.push(\`/r/${run.id}\`)` などで遷移。
- 表示中 run は **URL の runId から決定**。ページ読み込み時（初回・リロード・直接アクセス）に `GET /api/runs/[runId]` で取得して描画。

### 変更によって得られるメリット

| メリット | 説明 |
|----------|------|
| **共有・ブックマーク** | 「株式会社ドワンゴ」の URL（例: `https://app.example.com/r/abc123`）をコピーして共有したりブックマークできる。同じ URL を開けば同じ run が開く。 |
| **リロードで維持** | ある run を表示したままリロードしても、URL から同じ run を再取得して表示できる。 |
| **ブラウザ履歴と一致** | run A → run B と見たあと、「戻る」で run A の URL に戻り、その run が再表示される。 |
| **他 AI チャットと同様の体験** | ChatGPT などと同様に「1 会話 = 1 URL」になり、ユーザーの期待に沿いやすい。 |
| **デバッグ・サポート** | 「どの run で不具合か」を URL で特定しやすい。 |

### 変更時に必要な実装

1. **動的ルート**: `app/(home)/r/[runId]/page.tsx` のようなページを追加（または `app/(home)/page.tsx` で `runId` をクエリ/パスで受け取る設計）。
2. **URL と state の同期**:  
   - 履歴クリック → `router.push(\`/r/${id}\`)`。  
   - `/r/[runId]` を開いたときは `runId` から `GET /api/runs/[runId]` を呼び、結果を表示。
3. **新規チャット**: `/` または `/?new=1` で「run 未選択」の入力画面。新規生成して run ができたら `router.push(\`/r/${runId}\`)` で遷移するかどうかの方針を決める。
4. **認証・権限**: `/r/[runId]` で他人の run にアクセスできないよう、API と RLS で制限（現状の `GET /api/runs/[id]` がすでにユーザー紐づきならそのまま流用可能）。

---

## まとめ

- **現状**: どの run を表示していても URL は `/` のまま。状態はメモリ上の state のみで、共有・リロード・戻るに弱い。
- **パスを変える**: 「1 run = 1 URL」にすると、共有・ブックマーク・リロード・ブラウザ戻るが自然に動き、他 AI チャットに近い挙動になる。実装は動的ルートの追加と「URL → run 取得」の流れの組み込みが必要。
